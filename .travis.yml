sudo: required
language: java
jdk:
- openjdk11
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_f25c237cda72_key -iv $encrypted_f25c237cda72_iv
  -in travis/helseci.key.enc -out travis/helseci.key -d
- git clone https://github.com/navikt/github-apps-support.git
- export PATH=`pwd`/github-apps-support/bin:$PATH
- export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
  $GITHUB_APP_ID`)
- export COMMIT_SHORT=$(git rev-parse --short HEAD)
- export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
- echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
- "./gradlew check jar"
- docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT .
- |
  set -e
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
    echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

    git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

    cd helse-iac
    ./set-image.sh preprod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

    git config user.name team-helse[bot]
    git config user.email team-helse[bot]@users.noreply.github.com

    git add preprod/$APP_NAME/naiserator.yaml

    git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

    git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

    cd ..
    fi
before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
env:
  global:
  - APP_NAME=pleiepenger-oppgave
  - DOCKER_IMG_NAME=navikt/pleiepenger-oppgave
  - GITHUB_APP_ID=19726
  - secure: HmcoZkGQKLmElSGZDSpFBgFP7FYREGAkinLdeH4djuSqlzqHzCgSzECwzcqKfzt5BoKxHXPR3CVZlW1S1vW8B+ZXg6I5vrLP0Djy/lGlvIuekscjWAmjv/nfi1QqWXRfQFJejQ/0jq5NoD9iUI0uQAEh2VQNujmmPzAiXMI7lb9eW3SpjdyUl8Bt1AAU9201+j14HOpeSSHs79AChyqb7isGhnQlzofeRupL0mKH9+5k44GleRGq5LVjXYTSsAMcRqXyo+nF+V2gw2V23MJ3yUyoEdKE/ZWHBjtMk35IK2CKfYe16OHabs6o6O7zjviZ8i/trhCcR6MCrBoTyjlbE4prHDhgZNjOfRgIylxh8pHuLgk3ZX2XKwYVef8tCaYaKWF6QCrKf+f/r1afhbncsLRTTAJq9eI8kk3DVGI0ijWUEagU372TiyLgwla/BqD/5MGhKc+rIb/yg0OV2Wy3Ii7RKSyUOtRvgOIzI1+iYrVCtZkLj/2GvilftrbA8MEz1rDE7gTIetavN4bp18rzm4MJwOnnHkX8MQdUZ2A+THwfamR6cbBvM8BHD19AjfKvZQP/15P3c/du0BA9+jscoPbbkBuCW4duZesthjoRvLeBpZbohq7UF+Gm09u1wQZowG+xsI+9F4S1UCMptdWK/I6YdORS8xzyagYFO1G6oN8=
  - secure: QF6AJ7hJdWXXuTqh6uAnXhn0uwJg5oiAJjoeDH1sqigL0DdhfhvwzLlOL11VceCPkMakbirgNPparlPliem2E5LkXkbzjl9dyXZbbDrcZ9v5NicRieGXJZ50cx/T/mqgeI4Z6ObLfUxsdnvx/X2EHFumrJiZHaf7PwvrvE0mKlB22ujEGt0gftyd7hRImJJkE0GY+jzQNVf8jpM5ICHCrLiguITX25Bmkm+J6gbpSWTw4Ts9kGhyAJWvRAG1+rl9NOIcC4yiS8FwWPHdOxeM43fpTj5JQGnJbGK2czaUuetYS49SNM71IK2zAJAFqF3gfx1LsADru/duE7+7lZ5QMLXmhYRJJyAcbVnBRWsZUruMFXUADM+n3thzPup/vKOktADWe8yTSzmnzIXP0YcKKcWuO39vKecto6fHNau6cxdFO+jtwQ+YABQKiuZXrVSRh+t5wgJ40V2YTofyINsD4Ro/XRpCSN4pjDXJZtiKPh/NzCDvx2VnFRLrED9ENvAc0yRpCW/Ylv7U/y0tUTCeocnzv1kjPxUrQN+gxRhoNk4oEBbWFzI4W0qeh7tDT0hb49wSbBBYEPvCHRzuagPFfypAN4l2d4DetycIN9fwQJsAdLsudLkHbaToGX4DX2ICR2TjjUp6NwNAGea9QAiu0NBpJ1ckwujlkeZab3/wK38=
